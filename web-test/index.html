<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Free Time - Backend Test</title>
  <style>
    :root {
      --bg-primary: #0a0a0f;
      --bg-secondary: #12121a;
      --bg-tertiary: #1a1a24;
      --text-primary: #f0f0f5;
      --text-secondary: #8888a0;
      --accent: #6366f1;
      --accent-hover: #818cf8;
      --success: #22c55e;
      --error: #ef4444;
      --warning: #f59e0b;
      --info: #3b82f6;
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
      padding: 2rem;
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
    }
    
    h1 {
      font-size: 2rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
      background: linear-gradient(135deg, var(--accent), #a855f7);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    
    .subtitle {
      color: var(--text-secondary);
      margin-bottom: 2rem;
    }
    
    .status-bar {
      display: flex;
      gap: 1rem;
      margin-bottom: 2rem;
      padding: 1rem;
      background: var(--bg-secondary);
      border-radius: 12px;
      border: 1px solid var(--bg-tertiary);
    }
    
    .status-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--text-secondary);
    }
    
    .status-dot.connected {
      background: var(--success);
      box-shadow: 0 0 8px var(--success);
    }
    
    .status-dot.error {
      background: var(--error);
    }
    
    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 2rem;
    }
    
    .panel {
      background: var(--bg-secondary);
      border-radius: 16px;
      padding: 1.5rem;
      border: 1px solid var(--bg-tertiary);
    }
    
    .panel h2 {
      font-size: 1.1rem;
      font-weight: 500;
      margin-bottom: 1rem;
      color: var(--text-primary);
    }
    
    .upload-zone {
      border: 2px dashed var(--bg-tertiary);
      border-radius: 12px;
      padding: 2rem 1.5rem;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .upload-zone:hover {
      border-color: var(--accent);
      background: rgba(99, 102, 241, 0.05);
    }
    
    .upload-zone.dragover {
      border-color: var(--accent);
      background: rgba(99, 102, 241, 0.1);
    }
    
    .upload-icon {
      font-size: 2.5rem;
      margin-bottom: 0.75rem;
    }
    
    input[type="file"] {
      display: none;
    }
    
    .preview-image {
      max-width: 100%;
      max-height: 200px;
      border-radius: 8px;
      margin-top: 1rem;
    }
    
    button {
      background: var(--accent);
      color: white;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 8px;
      font-size: 0.95rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      width: 100%;
      margin-top: 1rem;
    }
    
    button:hover {
      background: var(--accent-hover);
    }
    
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .results {
      margin-top: 1rem;
    }
    
    .result-section {
      background: var(--bg-tertiary);
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 1rem;
    }
    
    .result-section h3 {
      font-size: 0.8rem;
      font-weight: 500;
      color: var(--accent);
      margin-bottom: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .result-section h3 .badge {
      background: var(--bg-primary);
      padding: 0.15rem 0.5rem;
      border-radius: 4px;
      font-size: 0.7rem;
      color: var(--text-secondary);
    }
    
    .result-content {
      font-size: 0.85rem;
      color: var(--text-secondary);
    }
    
    .result-content pre {
      white-space: pre-wrap;
      word-break: break-word;
      font-family: 'SF Mono', monospace;
      font-size: 0.75rem;
      background: var(--bg-primary);
      padding: 0.75rem;
      border-radius: 6px;
      max-height: 200px;
      overflow-y: auto;
    }
    
    .price-display {
      font-size: 1.4rem;
      font-weight: 600;
      color: var(--success);
    }
    
    .price-recommended {
      font-size: 0.9rem;
      color: var(--text-secondary);
      margin-top: 0.25rem;
    }
    
    .insights-list {
      list-style: none;
    }
    
    .insights-list li {
      padding: 0.4rem 0;
      border-bottom: 1px solid var(--bg-primary);
      font-size: 0.85rem;
    }
    
    .insights-list li:last-child {
      border-bottom: none;
    }
    
    .loader {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid var(--bg-tertiary);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 0.5rem;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .log-output {
      font-family: 'SF Mono', monospace;
      font-size: 0.75rem;
      background: var(--bg-primary);
      padding: 1rem;
      border-radius: 8px;
      max-height: 600px;
      overflow-y: auto;
    }
    
    .log-entry {
      padding: 0.2rem 0;
      border-bottom: 1px solid var(--bg-tertiary);
      line-height: 1.4;
    }
    
    .log-entry.info { color: var(--text-secondary); }
    .log-entry.success { color: var(--success); }
    .log-entry.error { color: var(--error); }
    .log-entry.warning { color: var(--warning); }
    .log-entry.stage { color: var(--info); font-weight: 500; }
    .log-entry.data { color: #a78bfa; font-size: 0.7rem; }
    
    .log-divider {
      border-top: 1px dashed var(--bg-tertiary);
      margin: 0.5rem 0;
    }
    
    /* Data grid for extracted info */
    .data-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.5rem;
    }
    
    .data-item {
      background: var(--bg-primary);
      padding: 0.5rem 0.75rem;
      border-radius: 6px;
    }
    
    .data-item.full {
      grid-column: 1 / -1;
    }
    
    .data-label {
      font-size: 0.65rem;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 0.2rem;
    }
    
    .data-value {
      font-size: 0.85rem;
      color: var(--text-primary);
      font-weight: 500;
    }
    
    .data-value.small {
      font-size: 0.75rem;
      font-weight: 400;
    }
    
    /* Listings display */
    .listings-container {
      max-height: 200px;
      overflow-y: auto;
    }
    
    .listing-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.4rem 0;
      border-bottom: 1px solid var(--bg-primary);
      font-size: 0.8rem;
    }
    
    .listing-item:last-child {
      border-bottom: none;
    }
    
    .listing-title {
      flex: 1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      margin-right: 0.5rem;
    }
    
    .listing-price {
      font-weight: 500;
      color: var(--success);
    }
    
    .listing-platform {
      font-size: 0.7rem;
      color: var(--text-secondary);
      margin-left: 0.5rem;
    }
    
    /* Stats row */
    .stats-row {
      display: flex;
      gap: 1rem;
      margin-bottom: 0.75rem;
    }
    
    .stat-item {
      background: var(--bg-primary);
      padding: 0.5rem 0.75rem;
      border-radius: 6px;
      flex: 1;
      text-align: center;
    }
    
    .stat-value {
      font-size: 1.2rem;
      font-weight: 600;
      color: var(--accent);
    }
    
    .stat-label {
      font-size: 0.65rem;
      color: var(--text-secondary);
      text-transform: uppercase;
    }
    
    /* Search queries */
    .search-queries {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
    }
    
    .search-query {
      background: var(--bg-primary);
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-size: 0.7rem;
      color: var(--text-secondary);
      font-family: 'SF Mono', monospace;
    }
    
    /* Brand tier badge */
    .tier-badge {
      display: inline-block;
      padding: 0.2rem 0.5rem;
      border-radius: 4px;
      font-size: 0.7rem;
      font-weight: 500;
      text-transform: uppercase;
    }
    
    .tier-badge.luxury { background: #7c3aed20; color: #a78bfa; }
    .tier-badge.premium { background: #3b82f620; color: #60a5fa; }
    .tier-badge.mid-range { background: #22c55e20; color: #4ade80; }
    .tier-badge.budget { background: #f59e0b20; color: #fbbf24; }
    .tier-badge.vintage { background: #ec489920; color: #f472b6; }
    .tier-badge.unknown { background: var(--bg-primary); color: var(--text-secondary); }
    
    /* Collapsible sections */
    .collapsible-header {
      cursor: pointer;
      user-select: none;
    }
    
    .collapsible-header::before {
      content: 'â–¼';
      font-size: 0.6rem;
      margin-right: 0.5rem;
      transition: transform 0.2s;
    }
    
    .collapsible-header.collapsed::before {
      transform: rotate(-90deg);
    }
    
    .collapsible-content {
      overflow: hidden;
      transition: max-height 0.2s ease-out;
    }
    
    .collapsible-content.collapsed {
      max-height: 0 !important;
    }
    
    /* Metrics Dashboard Styles */
    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    
    .metric-card {
      background: var(--bg-tertiary);
      border-radius: 8px;
      padding: 1rem;
      text-align: center;
    }
    
    .metric-value {
      font-size: 1.5rem;
      font-weight: 600;
      color: var(--accent);
    }
    
    .metric-value.success { color: var(--success); }
    .metric-value.cost { color: var(--warning); }
    
    .metric-label {
      font-size: 0.7rem;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-top: 0.25rem;
    }
    
    .metrics-section {
      margin-bottom: 1.5rem;
    }
    
    .metrics-section h3 {
      font-size: 0.9rem;
      font-weight: 500;
      color: var(--text-primary);
      margin-bottom: 0.75rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid var(--bg-tertiary);
    }
    
    .metrics-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.8rem;
    }
    
    .metrics-table th {
      text-align: left;
      color: var(--text-secondary);
      font-weight: 500;
      padding: 0.5rem;
      border-bottom: 1px solid var(--bg-tertiary);
    }
    
    .metrics-table td {
      padding: 0.5rem;
      border-bottom: 1px solid var(--bg-primary);
    }
    
    .metrics-table tr:last-child td {
      border-bottom: none;
    }
    
    .progress-bar {
      width: 100%;
      height: 6px;
      background: var(--bg-primary);
      border-radius: 3px;
      overflow: hidden;
    }
    
    .progress-bar-fill {
      height: 100%;
      background: var(--success);
      border-radius: 3px;
      transition: width 0.3s ease;
    }
    
    .recent-runs-list {
      max-height: 200px;
      overflow-y: auto;
    }
    
    .run-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.5rem;
      background: var(--bg-primary);
      border-radius: 6px;
      margin-bottom: 0.5rem;
      font-size: 0.75rem;
    }
    
    .run-item .stage {
      font-weight: 500;
      color: var(--accent);
      min-width: 80px;
    }
    
    .run-item .provider {
      color: var(--text-secondary);
      min-width: 80px;
    }
    
    .run-item .duration {
      color: var(--text-primary);
      min-width: 60px;
    }
    
    .run-item .tokens {
      color: var(--info);
      min-width: 80px;
    }
    
    .run-item .cost {
      color: var(--warning);
      min-width: 60px;
    }
    
    .run-item .status {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--success);
    }
    
    .run-item .status.failed {
      background: var(--error);
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Free Time</h1>
    <p class="subtitle">Backend Testing Interface</p>
    
    <div class="status-bar">
      <div class="status-item">
        <div class="status-dot" id="convex-status"></div>
        <span>Convex</span>
      </div>
      <div class="status-item">
        <span id="convex-url" style="color: var(--text-secondary); font-size: 0.85rem;"></span>
      </div>
    </div>
    
    <div class="grid">
      <div class="panel">
        <h2>Upload Tag Image</h2>
        <div class="upload-zone" id="upload-zone">
          <div class="upload-icon">ðŸ“·</div>
          <p>Drop an image here or click to upload</p>
          <p style="color: var(--text-secondary); font-size: 0.85rem; margin-top: 0.5rem;">Supports JPG, PNG, WebP</p>
        </div>
        <input type="file" id="file-input" accept="image/*">
        <img id="preview" class="preview-image" style="display: none;">
        <button id="process-btn" disabled>Process Tag</button>
        
        <div class="results" id="results" style="display: none;">
          <!-- Price Range -->
          <div class="result-section">
            <h3>Suggested Price Range</h3>
            <div class="result-content">
              <div class="price-display" id="price-range">--</div>
              <div class="price-recommended" id="price-recommended"></div>
            </div>
          </div>
          
          <!-- Key Data Points -->
          <div class="result-section">
            <h3>Key Data <span class="badge" id="image-type-badge">--</span></h3>
            <div class="data-grid" id="key-data">
              <!-- Filled dynamically -->
            </div>
          </div>
          
          <!-- Research Summary -->
          <div class="result-section">
            <h3 class="collapsible-header" onclick="toggleCollapsible(this)">Research Results <span class="badge" id="listings-count">0 listings</span></h3>
            <div class="collapsible-content" id="research-content">
              <div class="stats-row" id="research-stats">
                <!-- Filled dynamically -->
              </div>
              <div id="search-queries-container" style="margin-bottom: 0.75rem;">
                <div class="data-label">Search Queries Used</div>
                <div class="search-queries" id="search-queries"></div>
              </div>
              <div id="sold-listings-container">
                <div class="data-label">Top Sold Listings (Price Reference)</div>
                <div class="listings-container" id="sold-listings"></div>
              </div>
            </div>
          </div>
          
          <!-- Market Insights -->
          <div class="result-section">
            <h3>Market Insights</h3>
            <div class="result-content">
              <ul class="insights-list" id="insights"></ul>
            </div>
          </div>
          
          <!-- Raw Data (Collapsed) -->
          <div class="result-section">
            <h3 class="collapsible-header collapsed" onclick="toggleCollapsible(this)">Raw Extracted Data</h3>
            <div class="collapsible-content collapsed" id="raw-data-content">
              <pre id="extracted-data">{}</pre>
            </div>
          </div>
        </div>
      </div>
      
      <div class="panel">
        <h2>Processing Log</h2>
        <div class="log-output" id="log-output">
          <div class="log-entry info">Waiting for image upload...</div>
        </div>
      </div>
    </div>
    
    <!-- Metrics Dashboard -->
    <div class="panel" style="margin-top: 2rem;">
      <h2>ðŸ“Š Pipeline Metrics <button id="refresh-metrics-btn" style="width: auto; margin: 0; padding: 0.4rem 0.8rem; font-size: 0.8rem;">Refresh</button></h2>
      <div id="metrics-content">
        <div class="data-label" style="margin-bottom: 1rem;">Loading metrics...</div>
      </div>
    </div>
    
    <!-- Analytics Dashboard -->
    <div class="panel" style="margin-top: 2rem;">
      <h2>ðŸ“ˆ Scan Analytics <button id="refresh-analytics-btn" style="width: auto; margin: 0; padding: 0.4rem 0.8rem; font-size: 0.8rem;">Refresh</button></h2>
      <div id="analytics-content">
        <div class="data-label" style="margin-bottom: 1rem;">Loading analytics...</div>
      </div>
    </div>
  </div>

  <script type="module">
    import { ConvexClient } from "https://esm.sh/convex@1.31.3/browser";
    
    // Get Convex URL from environment or use default
    const CONVEX_URL = "https://qualified-sheep-863.convex.cloud";
    
    let convex;
    let selectedFile = null;
    let currentUserId = null;
    
    // DOM elements
    const uploadZone = document.getElementById('upload-zone');
    const fileInput = document.getElementById('file-input');
    const preview = document.getElementById('preview');
    const processBtn = document.getElementById('process-btn');
    const results = document.getElementById('results');
    const logOutput = document.getElementById('log-output');
    const convexStatus = document.getElementById('convex-status');
    const convexUrlEl = document.getElementById('convex-url');
    
    // Logging helper with levels
    function log(message, type = 'info') {
      const entry = document.createElement('div');
      entry.className = `log-entry ${type}`;
      const timestamp = new Date().toLocaleTimeString();
      entry.textContent = `[${timestamp}] ${message}`;
      logOutput.appendChild(entry);
      logOutput.scrollTop = logOutput.scrollHeight;
    }
    
    function logDivider() {
      const div = document.createElement('div');
      div.className = 'log-divider';
      logOutput.appendChild(div);
    }
    
    function logStage(stage, message) {
      logDivider();
      log(`â–¶ STAGE ${stage}: ${message}`, 'stage');
    }
    
    function logData(label, value) {
      log(`  ${label}: ${JSON.stringify(value)}`, 'data');
    }
    
    // Initialize Convex
    async function initConvex() {
      try {
        log('Connecting to Convex...');
        convexUrlEl.textContent = CONVEX_URL;
        
        convex = new ConvexClient(CONVEX_URL);
        
        // Create a test user (in production, this would come from WorkOS)
        log('Creating test user...');
        currentUserId = await convex.mutation("users:getOrCreateUser", {
          workosId: "test-user-" + Date.now(),
          email: "test@example.com",
          firstName: "Test",
          lastName: "User"
        });
        
        convexStatus.classList.add('connected');
        log('Connected to Convex!', 'success');
        log(`User ID: ${currentUserId}`, 'info');
      } catch (error) {
        convexStatus.classList.add('error');
        log(`Failed to connect: ${error.message}`, 'error');
      }
    }
    
    // File upload handling
    uploadZone.addEventListener('click', () => fileInput.click());
    
    uploadZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadZone.classList.add('dragover');
    });
    
    uploadZone.addEventListener('dragleave', () => {
      uploadZone.classList.remove('dragover');
    });
    
    uploadZone.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadZone.classList.remove('dragover');
      const file = e.dataTransfer.files[0];
      if (file && file.type.startsWith('image/')) {
        handleFile(file);
      }
    });
    
    fileInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        handleFile(file);
      }
    });
    
    function handleFile(file) {
      selectedFile = file;
      log(`Selected file: ${file.name} (${(file.size / 1024).toFixed(1)} KB)`);
      
      const reader = new FileReader();
      reader.onload = (e) => {
        preview.src = e.target.result;
        preview.style.display = 'block';
      };
      reader.readAsDataURL(file);
      
      processBtn.disabled = false;
    }
    
    // Process the tag
    processBtn.addEventListener('click', async () => {
      if (!selectedFile || !convex || !currentUserId) return;
      
      processBtn.disabled = true;
      processBtn.innerHTML = '<span class="loader"></span>Processing...';
      results.style.display = 'none';
      
      const startTime = Date.now();
      
      try {
        // Step 1: Upload image to Convex storage
        logStage(0, 'UPLOAD');
        log('Uploading image to Convex storage...');
        const uploadUrl = await convex.mutation("scans:generateUploadUrl", {});
        
        const uploadResponse = await fetch(uploadUrl, {
          method: 'POST',
          headers: { 'Content-Type': selectedFile.type },
          body: selectedFile
        });
        
        const { storageId } = await uploadResponse.json();
        log(`Image uploaded: ${storageId}`, 'success');
        logData('Storage ID', storageId);
        
        // Step 2: Create scan record
        log('Creating scan record...');
        const scanId = await convex.mutation("scans:createScan", {
          userId: currentUserId,
          imageStorageId: storageId
        });
        log(`Scan created: ${scanId}`, 'success');
        logData('Scan ID', scanId);
        
        // Step 3: Run the pipeline
        logStage(1, 'EXTRACTION');
        log('Analyzing image with AI vision...');
        
        const pipelineResult = await convex.action("pipeline/orchestrator:processScan", {
          scanId: scanId,
          imageStorageId: storageId
        });
        
        // Log extraction results
        if (pipelineResult.extractedData) {
          const ed = pipelineResult.extractedData;
          log('Extraction complete!', 'success');
          logData('Image Type', ed.imageTypes?.[0] || 'unknown');
          logData('Brand', ed.brand || 'Not found');
          if (ed.styleNumber) logData('Style #', ed.styleNumber);
          if (ed.sku) logData('SKU', ed.sku);
          if (ed.garmentAnalysis?.category) logData('Category', ed.garmentAnalysis.category);
          if (ed.garmentAnalysis?.style) logData('Style', ed.garmentAnalysis.style);
          logData('Confidence', `${(ed.confidence * 100).toFixed(0)}%`);
          if (ed.searchSuggestions?.length) {
            logData('AI Search Suggestions', ed.searchSuggestions.length + ' queries');
          }
        }
        
        // Log research results
        logStage(2, 'RESEARCH');
        if (pipelineResult.researchResults) {
          const rr = pipelineResult.researchResults;
          log(`Research complete!`, 'success');
          logData('Queries Executed', rr.searchQueries?.length || 0);
          logData('Active Listings', rr.listings?.length || 0);
          logData('Sold Listings', rr.soldListings?.length || 0);
          
          if (rr.soldListings?.length > 0) {
            const prices = rr.soldListings.filter(l => l.price > 0).map(l => l.price);
            if (prices.length > 0) {
              logData('Sold Price Range', `$${Math.min(...prices)} - $${Math.max(...prices)}`);
              logData('Sold Avg Price', `$${(prices.reduce((a,b) => a+b, 0) / prices.length).toFixed(2)}`);
            }
          }
          
          if (rr.searchQueries?.length > 0) {
            log('Search queries used:', 'info');
            rr.searchQueries.slice(0, 5).forEach((q, i) => {
              log(`  ${i+1}. ${q}`, 'data');
            });
          }
        }
        
        // Log refinement results
        logStage(3, 'REFINEMENT');
        if (pipelineResult.refinedFindings) {
          const rf = pipelineResult.refinedFindings;
          log('AI synthesis complete!', 'success');
          logData('Market Activity', rf.marketActivity);
          logData('Demand Level', rf.demandLevel);
          logData('Confidence', `${(rf.confidence * 100).toFixed(0)}%`);
          if (rf.brandTier) logData('Brand Tier', rf.brandTier);
          if (rf.suggestedPriceRange) {
            logData('Price Range', `$${rf.suggestedPriceRange.low} - $${rf.suggestedPriceRange.high}`);
            logData('Recommended', `$${rf.suggestedPriceRange.recommended}`);
          }
        }
        
        const totalTime = ((Date.now() - startTime) / 1000).toFixed(1);
        logDivider();
        log(`âœ“ Pipeline complete in ${totalTime}s`, 'success');
        
        // Display results
        displayResults(pipelineResult);
        
      } catch (error) {
        log(`Error: ${error.message}`, 'error');
        console.error(error);
      } finally {
        processBtn.disabled = false;
        processBtn.textContent = 'Process Tag';
      }
    });
    
    function displayResults(result) {
      results.style.display = 'block';
      
      // Price range
      const priceRange = document.getElementById('price-range');
      const priceRecommended = document.getElementById('price-recommended');
      if (result.refinedFindings?.suggestedPriceRange) {
        const range = result.refinedFindings.suggestedPriceRange;
        priceRange.textContent = `$${range.low.toFixed(2)} - $${range.high.toFixed(2)}`;
        priceRecommended.textContent = `Recommended: $${range.recommended.toFixed(2)}`;
      }
      
      // Image type badge
      const imageTypeBadge = document.getElementById('image-type-badge');
      const imageType = result.extractedData?.imageTypes?.[0] || 'unknown';
      imageTypeBadge.textContent = imageType.toUpperCase();
      
      // Key data grid
      const keyData = document.getElementById('key-data');
      keyData.innerHTML = '';
      const ed = result.extractedData || {};
      
      const addDataItem = (label, value, full = false) => {
        if (!value) return;
        const item = document.createElement('div');
        item.className = `data-item${full ? ' full' : ''}`;
        item.innerHTML = `
          <div class="data-label">${label}</div>
          <div class="data-value${full ? ' small' : ''}">${value}</div>
        `;
        keyData.appendChild(item);
      };
      
      // Brand with tier
      if (ed.brand) {
        const tier = result.refinedFindings?.brandTier || 'unknown';
        addDataItem('Brand', `${ed.brand} <span class="tier-badge ${tier}">${tier}</span>`);
      }
      
      addDataItem('Category', ed.garmentAnalysis?.category);
      addDataItem('Style', ed.garmentAnalysis?.style || ed.styleNumber);
      addDataItem('Size', ed.size);
      addDataItem('Condition', result.refinedFindings?.conditionImpact || ed.conditionAssessment?.overallGrade);
      addDataItem('Era', ed.garmentAnalysis?.estimatedEra);
      addDataItem('Materials', ed.materials?.join(', '), true);
      addDataItem('RN #', ed.rnNumber);
      addDataItem('Market', result.refinedFindings?.marketActivity);
      
      // Research results
      const rr = result.researchResults || {};
      const listingsCount = document.getElementById('listings-count');
      const totalListings = (rr.listings?.length || 0) + (rr.soldListings?.length || 0);
      listingsCount.textContent = `${totalListings} listings`;
      
      // Research stats
      const researchStats = document.getElementById('research-stats');
      researchStats.innerHTML = `
        <div class="stat-item">
          <div class="stat-value">${rr.listings?.length || 0}</div>
          <div class="stat-label">Active</div>
        </div>
        <div class="stat-item">
          <div class="stat-value">${rr.soldListings?.length || 0}</div>
          <div class="stat-label">Sold</div>
        </div>
        <div class="stat-item">
          <div class="stat-value">${rr.searchQueries?.length || 0}</div>
          <div class="stat-label">Queries</div>
        </div>
      `;
      
      // Search queries
      const searchQueries = document.getElementById('search-queries');
      searchQueries.innerHTML = '';
      (rr.searchQueries || []).slice(0, 6).forEach(q => {
        const span = document.createElement('span');
        span.className = 'search-query';
        span.textContent = q.length > 40 ? q.substring(0, 40) + '...' : q;
        span.title = q;
        searchQueries.appendChild(span);
      });
      
      // Sold listings
      const soldListings = document.getElementById('sold-listings');
      soldListings.innerHTML = '';
      const soldItems = (rr.soldListings || []).filter(l => l.price > 0).slice(0, 8);
      if (soldItems.length === 0) {
        soldListings.innerHTML = '<div style="color: var(--text-secondary); font-size: 0.8rem; padding: 0.5rem 0;">No sold listings found</div>';
      } else {
        soldItems.forEach(listing => {
          const item = document.createElement('div');
          item.className = 'listing-item';
          item.innerHTML = `
            <span class="listing-title" title="${listing.title}">${listing.title}</span>
            <span class="listing-price">$${listing.price.toFixed(0)}</span>
            <span class="listing-platform">${listing.platform}</span>
          `;
          soldListings.appendChild(item);
        });
      }
      
      // Insights
      const insights = document.getElementById('insights');
      insights.innerHTML = '';
      if (result.refinedFindings?.insights) {
        result.refinedFindings.insights.forEach(insight => {
          const li = document.createElement('li');
          li.textContent = insight;
          insights.appendChild(li);
        });
      }
      
      // Raw extracted data
      const extractedData = document.getElementById('extracted-data');
      extractedData.textContent = JSON.stringify(result.extractedData, null, 2);
      
      log('Results displayed', 'success');
    }
    
    // Collapsible toggle function (global)
    window.toggleCollapsible = function(header) {
      header.classList.toggle('collapsed');
      const content = header.nextElementSibling;
      content.classList.toggle('collapsed');
    };
    
    // Metrics Dashboard Functions
    async function loadMetrics() {
      if (!convex) return;
      
      const metricsContent = document.getElementById('metrics-content');
      metricsContent.innerHTML = '<div class="data-label">Loading metrics...</div>';
      
      try {
        // Load all metrics in parallel
        const [metrics, recentRuns, costSummary] = await Promise.all([
          convex.query("metrics:getPipelineMetrics", { days: 7 }),
          convex.query("metrics:getRecentPipelineRuns", { limit: 10 }),
          convex.query("metrics:getCostSummary", { days: 7 }),
        ]);
        
        renderMetrics(metrics, recentRuns, costSummary);
      } catch (error) {
        metricsContent.innerHTML = `<div class="log-entry error">Failed to load metrics: ${error.message}</div>`;
      }
    }
    
    function renderMetrics(metrics, recentRuns, costSummary) {
      const metricsContent = document.getElementById('metrics-content');
      
      // Format cost
      const formatCost = (cost) => cost < 0.01 ? '<$0.01' : `$${cost.toFixed(4)}`;
      const formatDuration = (ms) => ms < 1000 ? `${ms}ms` : `${(ms/1000).toFixed(1)}s`;
      
      metricsContent.innerHTML = `
        <!-- Overview Cards -->
        <div class="metrics-grid">
          <div class="metric-card">
            <div class="metric-value">${metrics.totalRuns}</div>
            <div class="metric-label">Total Runs (7d)</div>
          </div>
          <div class="metric-card">
            <div class="metric-value success">${metrics.successRate.toFixed(1)}%</div>
            <div class="metric-label">Success Rate</div>
          </div>
          <div class="metric-card">
            <div class="metric-value">${formatDuration(metrics.avgDurationMs)}</div>
            <div class="metric-label">Avg Duration</div>
          </div>
          <div class="metric-card">
            <div class="metric-value cost">${formatCost(metrics.totalCostUsd)}</div>
            <div class="metric-label">Total Cost (7d)</div>
          </div>
        </div>
        
        <!-- Stage Performance -->
        <div class="metrics-section">
          <h3>Stage Performance</h3>
          <table class="metrics-table">
            <thead>
              <tr>
                <th>Stage</th>
                <th>Runs</th>
                <th>Success</th>
                <th>Avg Time</th>
                <th>p95 Time</th>
                <th>Cost</th>
              </tr>
            </thead>
            <tbody>
              ${Object.entries(metrics.byStage).map(([stage, data]) => `
                <tr>
                  <td style="text-transform: capitalize;">${stage}</td>
                  <td>${data.count}</td>
                  <td>
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                      <div class="progress-bar" style="width: 60px;">
                        <div class="progress-bar-fill" style="width: ${data.successRate}%;"></div>
                      </div>
                      <span>${data.successRate.toFixed(0)}%</span>
                    </div>
                  </td>
                  <td>${formatDuration(data.avgDurationMs)}</td>
                  <td>${formatDuration(data.p95DurationMs)}</td>
                  <td>${formatCost(data.totalCostUsd)}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
        
        <!-- Provider Breakdown -->
        <div class="metrics-section">
          <h3>Provider Breakdown</h3>
          <table class="metrics-table">
            <thead>
              <tr>
                <th>Provider</th>
                <th>Runs</th>
                <th>Avg Input Tokens</th>
                <th>Avg Output Tokens</th>
                <th>Total Cost</th>
              </tr>
            </thead>
            <tbody>
              ${Object.entries(metrics.byProvider).map(([provider, data]) => `
                <tr>
                  <td style="text-transform: capitalize;">${provider}</td>
                  <td>${data.count}</td>
                  <td>${data.avgInputTokens > 0 ? Math.round(data.avgInputTokens).toLocaleString() : '-'}</td>
                  <td>${data.avgOutputTokens > 0 ? Math.round(data.avgOutputTokens).toLocaleString() : '-'}</td>
                  <td>${formatCost(data.totalCostUsd)}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
        
        <!-- Recent Runs -->
        <div class="metrics-section">
          <h3>Recent Pipeline Runs</h3>
          <div class="recent-runs-list">
            ${recentRuns.length === 0 ? '<div style="color: var(--text-secondary); padding: 1rem;">No pipeline runs yet</div>' : 
              recentRuns.map(run => `
                <div class="run-item">
                  <span class="stage">${run.stage}</span>
                  <span class="provider">${run.provider}</span>
                  <span class="duration">${formatDuration(run.durationMs)}</span>
                  <span class="tokens">${run.totalTokens ? run.totalTokens.toLocaleString() + ' tok' : '-'}</span>
                  <span class="cost">${run.estimatedCostUsd ? formatCost(run.estimatedCostUsd) : '-'}</span>
                  <span class="status ${run.success ? '' : 'failed'}" title="${run.success ? 'Success' : run.errorMessage || 'Failed'}"></span>
                </div>
              `).join('')
            }
          </div>
        </div>
      `;
    }
    
    // Refresh metrics button
    document.getElementById('refresh-metrics-btn').addEventListener('click', loadMetrics);
    
    // Analytics Dashboard Functions
    async function loadAnalytics() {
      if (!convex) return;
      
      const analyticsContent = document.getElementById('analytics-content');
      analyticsContent.innerHTML = '<div class="data-label">Loading analytics...</div>';
      
      try {
        const summary = await convex.query("analytics:getAnalyticsSummary", {});
        renderAnalytics(summary);
      } catch (error) {
        analyticsContent.innerHTML = `<div class="log-entry error">Failed to load analytics: ${error.message}</div>`;
      }
    }
    
    function renderAnalytics(summary) {
      const analyticsContent = document.getElementById('analytics-content');
      
      analyticsContent.innerHTML = `
        <!-- Analytics Overview Cards -->
        <div class="metrics-grid">
          <div class="metric-card">
            <div class="metric-value">${summary.totalScansAnonymized}</div>
            <div class="metric-label">Scans Captured</div>
          </div>
          <div class="metric-card">
            <div class="metric-value">${summary.uniqueBrands}</div>
            <div class="metric-label">Unique Brands</div>
          </div>
          <div class="metric-card">
            <div class="metric-value">${summary.scansWithPriceData}</div>
            <div class="metric-label">With Price Data</div>
          </div>
          <div class="metric-card">
            <div class="metric-value cost">$${summary.avgRecommendedPrice.toFixed(0)}</div>
            <div class="metric-label">Avg Rec. Price</div>
          </div>
        </div>
        
        <div class="metrics-section">
          <h3>Crowdsourced Data</h3>
          <div class="result-content" style="padding: 1rem; background: var(--bg-primary); border-radius: 8px;">
            <p style="color: var(--text-secondary); font-size: 0.85rem; line-height: 1.5;">
              ${summary.totalScansAnonymized === 0 
                ? 'ðŸ“Š No anonymized data collected yet. Process some scans to start building crowdsourced pricing intelligence!'
                : `ðŸ“Š <strong>${summary.totalScansAnonymized}</strong> anonymized scans have contributed to our pricing database across <strong>${summary.uniqueBrands}</strong> brands. This data helps improve pricing recommendations for everyone.`
              }
            </p>
            ${summary.brandStatsComputed > 0 
              ? `<p style="color: var(--success); font-size: 0.8rem; margin-top: 0.5rem;">âœ“ ${summary.brandStatsComputed} brand statistics computed</p>`
              : ''
            }
          </div>
        </div>
      `;
    }
    
    // Refresh analytics button
    document.getElementById('refresh-analytics-btn').addEventListener('click', loadAnalytics);
    
    // Initialize
    initConvex();
    
    // Load metrics and analytics after a short delay to ensure convex is connected
    setTimeout(() => {
      loadMetrics();
      loadAnalytics();
    }, 1500);
  </script>
</body>
</html>
